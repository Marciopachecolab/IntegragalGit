Vou analisar o mÃ³dulo de anÃ¡lise em detalhes para vocÃª. Deixe-me ler o arquivo primeiro:

Completed File Reading
/workspace/database/models/analysis.py
Thinking Process
3.44s
Excelente! Vou fazer uma anÃ¡lise detalhada do mÃ³dulo de anÃ¡lise. Este Ã© o coraÃ§Ã£o do sistema IntegragalGit.

ğŸ§¬ Arquitetura Geral do MÃ³dulo de AnÃ¡lise
O mÃ³dulo estÃ¡ dividido em duas camadas principais:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        CAMADA DE CONFIGURAÃ‡ÃƒO               â”‚
â”‚  (Define "O QUE" e "COMO" analisar)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Equipamento (AB7500, QuantStudio...)     â”‚
â”‚ â€¢ KitReagente (Bio-Manguinhos, GeneSig...) â”‚
â”‚ â€¢ Exame (VR1e2, COVID-19...)               â”‚
â”‚ â€¢ ExameAlvo (IAV, IBV, VSR, HMPV...)       â”‚
â”‚ â€¢ ExameControle (Positivo, Negativo...)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        CAMADA DE EXECUÃ‡ÃƒO                   â”‚
â”‚  (Armazena resultados REAIS)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Analise (Run completo de PCR)            â”‚
â”‚ â€¢ Amostra (Paciente individual)            â”‚
â”‚ â€¢ ResultadoAlvo (Ct values por alvo)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ğŸ“Š Parte 1: ENUMs (EnumeraÃ§Ãµes)
1. TipoControle (linhas 26-31)
python
class TipoControle(enum.Enum):
    POSITIVO = "positivo"    # Deve amplificar - valida se reagentes funcionam
    NEGATIVO = "negativo"    # NÃƒO deve amplificar - valida contaminaÃ§Ã£o
    INTERNO = "interno"      # RNAseP - valida extraÃ§Ã£o de RNA
    EXTERNO = "externo"      # Controles externos opcionais
Por que existem controles?

Controle Positivo: Garante que o kit estÃ¡ detectando corretamente
Controle Negativo: Garante que nÃ£o hÃ¡ contaminaÃ§Ã£o
Controle Interno (RNAseP): Garante que a extraÃ§Ã£o de RNA funcionou
2. StatusAnalise (linhas 34-40)
python
class StatusAnalise(enum.Enum):
    PENDENTE = "pendente"          # Arquivo carregado, aguardando processamento
    PROCESSANDO = "processando"    # Sistema lendo e validando dados
    CONCLUIDA = "concluida"        # Processamento OK, resultados salvos
    ERRO = "erro"                  # Falha no processamento
    CANCELADA = "cancelada"        # UsuÃ¡rio cancelou
3. ResultadoFinal (linhas 43-48)
python
class ResultadoFinal(enum.Enum):
    POSITIVO = "positivo"          # Pelo menos 1 alvo positivo
    NEGATIVO = "negativo"          # Todos alvos negativos + controle interno OK
    INCONCLUSIVO = "inconclusivo"  # Resultados ambÃ­guos
    INVALIDO = "invalido"          # Controles falharam
ğŸ”§ Parte 2: CAMADA DE CONFIGURAÃ‡ÃƒO
1. Equipamento (linhas 55-99)
python
class Equipamento:
    codigo = "AB7500"
    nome = "Applied Biosystems 7500"
    fabricante = "Thermo Fisher"
    numero_canais = 5              # FAM, VIC, ROX, etc.
    pocos_por_placa = 96           # Placa de 96 poÃ§os
    identificador_arquivo = "7500" # Para detectar tipo de arquivo
    formato_saida = "excel"        # xlsx, csv, txt
FunÃ§Ã£o: Define as caracterÃ­sticas fÃ­sicas e tÃ©cnicas do equipamento de PCR.

Por que Ã© importante?

Cada equipamento gera arquivos em formatos diferentes
O sistema precisa auto-detectar qual equipamento gerou o arquivo
Cada equipamento tem nÃºmero diferente de canais de fluorescÃªncia
Exemplo prÃ¡tico:

AB7500 â†’ gera arquivo "7500_Results_2025.xlsx"
QuantStudio â†’ gera arquivo "QuantStudio_Run123.csv"
2. KitReagente (linhas 102-142)
python
class KitReagente:
    codigo = "BIOMANGUINHOS_VR1E2"
    nome = "Kit Biomol VR1e2"
    fabricante = "Bio-Manguinhos"
    lote = "L2025001"
    validade = datetime(2025, 12, 31)
    alvos_detectados = ['IAV', 'IBV', 'VSR', 'HMPV']  # VÃ­rus detectados
FunÃ§Ã£o: Define qual kit/protocolo foi usado na anÃ¡lise.

Por que rastrear kits?

Kits diferentes detectam vÃ­rus diferentes
Cada lote pode ter sensibilidade diferente
Rastreabilidade para auditorias e troubleshooting
3. Exame (linhas 145-203) - O MAESTRO
python
class Exame:
    codigo = "VR1E2"
    nome = "Painel VÃ­rus RespiratÃ³rios 1 e 2"
    versao = "2.0"
    
    # Equipamento e kit que usa
    equipamento_padrao_id = 1  # AB7500
    kit_padrao_id = 1          # Bio-Manguinhos
    
    # ConfiguraÃ§Ãµes JSON flexÃ­veis
    configuracao_json = {
        "temperatura_ciclos": 95,
        "numero_ciclos": 45,
        "modo_analise": "quantitativo"
    }
FunÃ§Ã£o: Orquestra tudo - define qual equipamento usar, qual kit, quais alvos detectar e quais controles validar.

Relacionamentos importantes:

Exame
  â”œâ”€â†’ Equipamento PadrÃ£o (qual mÃ¡quina usar)
  â”œâ”€â†’ Kit PadrÃ£o (qual protocolo)
  â”œâ”€â†’ Alvos[] (O QUE detectar)
  â””â”€â†’ Controles[] (COMO validar)
4. ExameAlvo (linhas 206-244) - O QUE DETECTAR
python
class ExameAlvo:
    exame_id = 1                       # Pertence ao exame VR1e2
    nome = "IAV"                       # CÃ³digo curto
    nome_completo = "Influenza A Virus"
    canal_fluorescencia = "FAM"        # Canal onde aparece o sinal
    
    # ParÃ¢metros crÃ­ticos de interpretaÃ§Ã£o
    ct_threshold = 40.0                # Limite mÃ¡ximo de detecÃ§Ã£o
    ct_positivo_max = 37.0             # Ct â‰¤ 37 = POSITIVO
    ct_limite_deteccao = 40.0          # Ct > 40 = NEGATIVO
Como funciona a lÃ³gica Ct?

Ct (Cycle Threshold) = Ciclo onde hÃ¡ amplificaÃ§Ã£o detectÃ¡vel

Se Ct â‰¤ 37.0  â†’ POSITIVO  (muita carga viral)
Se 37 < Ct â‰¤ 40 â†’ INCONCLUSIVO (carga viral baixa)
Se Ct > 40 ou "Undetermined" â†’ NEGATIVO (sem vÃ­rus)
Exemplo real:

Amostra GAL001:
  IAV (FAM):  Ct = 28.5  â†’ POSITIVO âœ…
  IBV (VIC):  Ct = Undetermined â†’ NEGATIVO âŒ
  VSR (ROX):  Ct = 38.2  â†’ INCONCLUSIVO âš ï¸
  HMPV (Cy5): Ct = 41.0  â†’ NEGATIVO âŒ
  
Resultado Final: POSITIVO (IAV detectado)
5. ExameControle (linhas 247-284) - VALIDAÃ‡ÃƒO
python
class ExameControle:
    exame_id = 1
    tipo = TipoControle.POSITIVO
    nome = "Controle Positivo Mix"
    posicoes_placa = ['H11', 'H12']    # Onde ficam na placa
    
    # Faixas esperadas
    ct_esperado_min = 20.0
    ct_esperado_max = 30.0
    obrigatorio = True
LÃ³gica de validaÃ§Ã£o:

python
# PseudocÃ³digo de validaÃ§Ã£o
def validar_controle_positivo(ct_value):
    if ct_value < 20.0:
        return "FALHA: ContaminaÃ§Ã£o ou concentraÃ§Ã£o incorreta"
    elif 20.0 <= ct_value <= 30.0:
        return "OK: Controle vÃ¡lido âœ…"
    elif ct_value > 30.0:
        return "FALHA: Kit degradado ou reagentes inativos"
Se controles falham â†’ TODA anÃ¡lise Ã© INVÃLIDA âš ï¸

ğŸš€ Parte 3: CAMADA DE EXECUÃ‡ÃƒO
6. Analise (linhas 291-360) - A CORRIDA
python
class Analise:
    codigo = "RUN-2025-001"
    exame_id = 1                           # VR1e2
    equipamento_id = 1                     # AB7500
    usuario_id = 5                         # Quem executou
    
    arquivo_entrada = "/uploads/7500_results_2025.xlsx"
    arquivo_saida = "/reports/relatorio_RUN-2025-001.pdf"
    
    status = StatusAnalise.CONCLUIDA
    data_execucao = datetime(2025, 11, 22, 10, 30)
    
    # EstatÃ­sticas
    total_amostras = 88
    amostras_positivas = 12
    amostras_negativas = 70
    amostras_inconclusivas = 4
    amostras_invalidas = 2
    
    # ValidaÃ§Ã£o crÃ­tica
    controles_validos = True
    mensagem_validacao = "Todos controles dentro dos parÃ¢metros"
Representa: Uma execuÃ§Ã£o completa de PCR (uma placa de 96 poÃ§os).

Workflow:

1. PENDENTE: Arquivo carregado
2. PROCESSANDO: Sistema lÃª Excel/CSV
3. Valida controles â†’ Se FALHA = ERRO
4. Processa amostras uma por uma
5. Gera estatÃ­sticas
6. CONCLUIDA: RelatÃ³rio gerado
7. Amostra (linhas 363-398) - O PACIENTE
python
class Amostra:
    analise_id = 123
    identificador = "GAL20250001"      # ID Ãºnico do GAL
    posicao_placa = "A1"               # LocalizaÃ§Ã£o fÃ­sica
    resultado_final = ResultadoFinal.POSITIVO
    observacoes = "IAV detectado com Ct baixo"
Relacionamento com ResultadoAlvo:

Amostra GAL20250001
  â”œâ”€â†’ ResultadoAlvo 1: IAV = Positivo (Ct 28.5)
  â”œâ”€â†’ ResultadoAlvo 2: IBV = Negativo (Ct Und)
  â”œâ”€â†’ ResultadoAlvo 3: VSR = Negativo (Ct Und)
  â”œâ”€â†’ ResultadoAlvo 4: HMPV = Negativo (Ct Und)
  â””â”€â†’ ResultadoAlvo 5: RNAseP = Positivo (Ct 25.0) âœ… Controle Interno OK
8. ResultadoAlvo (linhas 401-429) - GRANULARIDADE
python
class ResultadoAlvo:
    amostra_id = 456
    alvo_id = 1                        # IAV
    ct_value = 28.5
    resultado = "Positivo"
Por que separar resultados por alvo?

Permite anÃ¡lises estatÃ­sticas: "Quantos IAV positivos este mÃªs?"
Rastreabilidade: "Qual alvo estÃ¡ dando mais inconclusivos?"
ValidaÃ§Ã£o: "RNAseP amplificou? Se nÃ£o, amostra INVÃLIDA"
ğŸ”„ Fluxo Completo de Dados
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CONFIGURAÃ‡ÃƒO (feita UMA vez por exame)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Cadastrar Equipamento (AB7500)                            â”‚
â”‚ â€¢ Cadastrar Kit (Bio-Manguinhos VR1e2)                      â”‚
â”‚ â€¢ Criar Exame (VR1e2)                                       â”‚
â”‚   â”œâ”€ Adicionar 4 Alvos (IAV, IBV, VSR, HMPV)              â”‚
â”‚   â””â”€ Adicionar 3 Controles (Pos, Neg, Interno)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. EXECUÃ‡ÃƒO (para cada corrida de PCR)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ UsuÃ¡rio carrega arquivo do equipamento                    â”‚
â”‚ â€¢ Sistema detecta automaticamente tipo de equipamento       â”‚
â”‚ â€¢ Cria Analise (status=PENDENTE)                           â”‚
â”‚ â€¢ Inicia processamento (status=PROCESSANDO)                â”‚
â”‚   â”œâ”€ Valida Controles                                      â”‚
â”‚   â”‚   â””â”€ Se FALHA â†’ status=ERRO, para tudo               â”‚
â”‚   â”œâ”€ Para cada linha do arquivo:                          â”‚
â”‚   â”‚   â”œâ”€ Cria Amostra                                     â”‚
â”‚   â”‚   â”œâ”€ Para cada alvo:                                  â”‚
â”‚   â”‚   â”‚   â””â”€ Cria ResultadoAlvo com Ct                   â”‚
â”‚   â”‚   â””â”€ Calcula resultado_final da amostra              â”‚
â”‚   â”œâ”€ Gera estatÃ­sticas                                     â”‚
â”‚   â””â”€ Gera relatÃ³rio PDF                                    â”‚
â”‚ â€¢ status=CONCLUIDA                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ğŸ’¡ Exemplo PrÃ¡tico Completo
CenÃ¡rio: LaboratÃ³rio recebe 88 amostras para testar vÃ­rus respiratÃ³rios

Passo 1: PreparaÃ§Ã£o da Placa

Placa 96 poÃ§os:
A1-H10: 80 amostras de pacientes
H11-H12: Controle Positivo (duplicata)
A11-B11: Controle Negativo (duplicata)
Todas amostras: Controle Interno RNAseP
Passo 2: ExecuÃ§Ã£o no AB7500

Equipamento roda 45 ciclos
Gera arquivo: "7500_Results_20251122.xlsx"
Passo 3: Processamento no IntegragalGit

python
# Sistema detecta arquivo
analise = Analise(
    codigo="RUN-20251122-001",
    exame_id=1,  # VR1e2
    equipamento_id=1,  # AB7500
    arquivo_entrada="7500_Results_20251122.xlsx"
)

# Valida controles
ctrl_positivo_h11 = 25.3  # âœ… Entre 20-30
ctrl_positivo_h12 = 26.1  # âœ… Entre 20-30
ctrl_negativo_a11 = "Und" # âœ… NÃ£o amplificou
ctrl_negativo_b11 = "Und" # âœ… NÃ£o amplificou

analise.controles_validos = True

# Processa amostra 1
amostra_1 = Amostra(
    identificador="GAL20250001",
    posicao_placa="A1"
)

# Resultados dos alvos
ResultadoAlvo(amostra=amostra_1, alvo=IAV, ct_value=28.5, resultado="Positivo")
ResultadoAlvo(amostra=amostra_1, alvo=IBV, ct_value=None, resultado="Negativo")
ResultadoAlvo(amostra=amostra_1, alvo=VSR, ct_value=None, resultado="Negativo")
ResultadoAlvo(amostra=amostra_1, alvo=HMPV, ct_value=None, resultado="Negativo")
ResultadoAlvo(amostra=amostra_1, alvo=RNAseP, ct_value=24.8, resultado="Positivo")

# Determina resultado final
amostra_1.resultado_final = ResultadoFinal.POSITIVO  # IAV detectado

# Processa restante das 87 amostras...

# EstatÃ­sticas finais
analise.total_amostras = 88
analise.amostras_positivas = 12
analise.amostras_negativas = 70
analise.amostras_inconclusivas = 4
analise.amostras_invalidas = 2
analise.status = StatusAnalise.CONCLUIDA
ğŸ¯ Vantagens Desta Arquitetura
âœ… Universal: Funciona com qualquer equipamento (basta cadastrar)

âœ… FlexÃ­vel: Novos exames sem alterar cÃ³digo

âœ… RastreÃ¡vel: HistÃ³rico completo de cada anÃ¡lise

âœ… AuditÃ¡vel: Relaciona usuÃ¡rio + data + arquivos

âœ… EscalÃ¡vel: Milhares de anÃ¡lises sem degradaÃ§Ã£o

âœ… ValidÃ¡vel: Controles garantem qualidade dos resultados

ğŸ“Œ PrÃ³ximo Passo: AnalysisService
Agora que vocÃª entende O QUE o mÃ³dulo armazena, preciso criar o AnalysisService que:

1.
LÃª arquivos Excel/CSV dos equipamentos
2.
Detecta automaticamente qual equipamento gerou
3.
Valida os controles
4.
Processa as amostras
5.
Calcula resultados finais
6.
Gera relatÃ³rios PDF