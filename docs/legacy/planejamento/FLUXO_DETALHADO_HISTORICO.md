# ğŸ“Š Diagrama Detalhado: Fluxo de Dados do HistÃ³rico

## ğŸ”„ Fluxo Completo com Dados Reais

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AMOSTRA ORIGINAL (df_final)                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Codigo      â”‚ Amostraâ”‚ Poco    â”‚ Resultado_SC2â”‚ SC2-CT  â”‚ RP1  â”‚ Status â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 422386149   â”‚ 422386 â”‚ A1+A2   â”‚ Detectado    â”‚ 38.456  â”‚ 25.5 â”‚ VÃ¡lida â”‚
â”‚ 422386266   â”‚ 422387 â”‚ B1+B2   â”‚ NÃ£o Detectadoâ”‚         â”‚ 28.3 â”‚ VÃ¡lida â”‚
â”‚ CN          â”‚ CN     â”‚ G11+G12 â”‚ Detectado    â”‚ 36.200  â”‚ 24.0 â”‚ VÃ¡lida â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£ VALIDAÃ‡ÃƒO (_salvar_selecionados)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Para amostra "CN":                                                       â”‚
â”‚ â”œâ”€ CÃ³digo contÃ©m "CN"? âœ… SIM â†’ Desmarcada automaticamente              â”‚
â”‚ â”œâ”€ Status: NÃƒO serÃ¡ adicionada ao histÃ³rico                             â”‚
â”‚ â””â”€ Feedback: Silenciosamente removida                                    â”‚
â”‚                                                                          â”‚
â”‚ Para amostra "422386149":                                                â”‚
â”‚ â”œâ”€ Selecionado? âœ… SIM                                                  â”‚
â”‚ â”œâ”€ CÃ³digo numÃ©rico? âœ… SIM                                              â”‚
â”‚ â”œâ”€ Resultado invÃ¡lido? âŒ NÃƒO                                           â”‚
â”‚ â””â”€ Status: âœ… APROVADA para histÃ³rico                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ï¸âƒ£ CARREGAMENTO DE CONFIGURAÃ‡ÃƒO (gerar_historico_csv)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cfg = get_exam_cfg("vr1e2_biomanguinhos_7500")                          â”‚
â”‚                                                                          â”‚
â”‚ ConfiguraÃ§Ã£o carregada:                                                  â”‚
â”‚ â”œâ”€ alvos: ["SC2", "HMPV", "INF A", "INF B", "ADV", "RSV", "HRV"]      â”‚
â”‚ â”œâ”€ rps: ["RP1", "RP2"]                                                  â”‚
â”‚ â”œâ”€ faixas_ct: { detect_max: 38.0, rp_min: 15.0, rp_max: 35.0 }        â”‚
â”‚ â””â”€ normalize_target(): callable para normalizar nomes                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ï¸âƒ£ DESCOBERTA DE COLUNAS CT                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Alvo: "SC2"                                                              â”‚
â”‚ â”œâ”€ Candidatos testados:                                                 â”‚
â”‚ â”‚  â”œâ”€ "SC2" â†’ âŒ nÃ£o encontrado                                         â”‚
â”‚ â”‚  â”œâ”€ "SC2" (upper) â†’ âŒ nÃ£o encontrado                                â”‚
â”‚ â”‚  â”œâ”€ "SC2 - CT" â†’ âœ… ENCONTRADO!                                     â”‚
â”‚ â””â”€ Resultado: col_ct = "SC2 - CT"                                       â”‚
â”‚                                                                          â”‚
â”‚ Alvo: "INF A"                                                            â”‚
â”‚ â”œâ”€ Candidatos testados:                                                 â”‚
â”‚ â”‚  â”œâ”€ "INF A" â†’ âŒ nÃ£o encontrado                                       â”‚
â”‚ â”‚  â”œâ”€ "INFA" â†’ âŒ nÃ£o encontrado                                        â”‚
â”‚ â”‚  â”œâ”€ "INF A - CT" â†’ âœ… ENCONTRADO!                                   â”‚
â”‚ â””â”€ Resultado: col_ct = "INF A - CT"                                     â”‚
â”‚                                                                          â”‚
â”‚ Alvo: "HMPV"                                                             â”‚
â”‚ â””â”€ Resultado: col_ct = "HMPV - CT"                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ï¸âƒ£ MAPEAMENTO RESULTADO â†’ CÃ“DIGO                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ FunÃ§Ã£o: _map_result(val)                                                 â”‚
â”‚                                                                          â”‚
â”‚ "Detectado" â†’ "1"       (Positivo)                                       â”‚
â”‚ "NÃ£o Detectado" â†’ "2"   (Negativo)                                       â”‚
â”‚ "Inconclusivo" â†’ "3"    (Indeterminado)                                  â”‚
â”‚ "" â†’ ""                 (Vazio/Faltante)                                 â”‚
â”‚ "InvÃ¡lido" â†’ ""         (NÃ£o serÃ¡ exportado)                             â”‚
â”‚                                                                          â”‚
â”‚ Exemplo real:                                                            â”‚
â”‚ â”œâ”€ r.get("Resultado_SC2") = "Detectado"                                 â”‚
â”‚ â”œâ”€ res_code = _map_result("Detectado") = "1"                            â”‚
â”‚ â””â”€ SaÃ­da: "SC2 - 1"                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5ï¸âƒ£ FORMATAÃ‡ÃƒO CT (Cycle Threshold)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ FunÃ§Ã£o: _fmt_ct(val)                                                     â”‚
â”‚                                                                          â”‚
â”‚ 38.456 â†’ "38,456"           (3 casas decimais, vÃ­rgula portuguesa)     â”‚
â”‚ 25.5 â†’ "25,500"             (Preenche com zeros)                        â”‚
â”‚ None â†’ ""                   (Campo vazio)                               â”‚
â”‚ "UNDETERMINED" â†’ ""         (Valor especial â†’ vazio)                    â”‚
â”‚ 36.1234567 â†’ "36,123"       (Trunca para 3 casas)                      â”‚
â”‚                                                                          â”‚
â”‚ Exemplo real:                                                            â”‚
â”‚ â”œâ”€ r.get("SC2 - CT") = 38.456                                          â”‚
â”‚ â”œâ”€ formatted = _fmt_ct(38.456) = "38,456"                              â”‚
â”‚ â””â”€ SaÃ­da: linha["SC2 - CT"] = "38,456"                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6ï¸âƒ£ DETERMINAÃ‡ÃƒO DE STATUS GAL                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Por padrÃ£o: status_gal = "analizado e nao enviado"                      â”‚
â”‚                                                                          â”‚
â”‚ ExceÃ§Ãµes:                                                                â”‚
â”‚ â”œâ”€ Se cÃ³digo nÃ£o Ã© numÃ©rico:                                            â”‚
â”‚ â”‚  â”œâ”€ status_gal = "tipo nao enviavel"                                  â”‚
â”‚ â”‚  â””â”€ mensagem_gal = "codigo nao numerico ou controle"                  â”‚
â”‚ â”‚                                                                        â”‚
â”‚ â”œâ”€ Se cÃ³digo contÃ©m "CN":                                               â”‚
â”‚ â”‚  â”œâ”€ status_gal = "tipo nao enviavel"                                  â”‚
â”‚ â”‚  â””â”€ mensagem_gal = "codigo nao numerico ou controle"                  â”‚
â”‚ â”‚                                                                        â”‚
â”‚ â””â”€ Se cÃ³digo contÃ©m "CP":                                               â”‚
â”‚    â”œâ”€ status_gal = "tipo nao enviavel"                                  â”‚
â”‚    â””â”€ mensagem_gal = "codigo nao numerico ou controle"                  â”‚
â”‚                                                                          â”‚
â”‚ Exemplos:                                                                â”‚
â”‚ â”œâ”€ CÃ³digo "422386149" â†’ status_gal = "analizado e nao enviado"          â”‚
â”‚ â”œâ”€ CÃ³digo "CN" â†’ status_gal = "tipo nao enviavel"                      â”‚
â”‚ â””â”€ CÃ³digo "CP" â†’ status_gal = "tipo nao enviavel"                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7ï¸âƒ£ CONSTRUÃ‡ÃƒO DA LINHA DE HISTÃ“RICO                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Para amostra 422386149:                                                  â”‚
â”‚                                                                          â”‚
â”‚ linha = {                                                                â”‚
â”‚   "data_hora_analise": "2025-12-05 19:54:54",                          â”‚
â”‚   "usuario_analise": "mÃ¡rcio",                                          â”‚
â”‚   "exame": "vr1e2_biomanguinhos_7500",                                  â”‚
â”‚   "lote": "",                                                            â”‚
â”‚   "arquivo_corrida": "",                                                 â”‚
â”‚   "poco": "A1+A2",                                                       â”‚
â”‚   "amostra": "422386",                                                   â”‚
â”‚   "codigo": "422386149",                                                 â”‚
â”‚   "status_corrida": "VÃ¡lida",                                            â”‚
â”‚   "status_gal": "analizado e nao enviado",                              â”‚
â”‚   "mensagem_gal": "",                                                    â”‚
â”‚   "criado_em": "2025-12-05 19:54:54",                                   â”‚
â”‚   "atualizado_em": "2025-12-05 19:54:54",                               â”‚
â”‚   "SC2 - R": "SC2 - 1",                    â† Mapeado                    â”‚
â”‚   "SC2 - CT": "38,456",                    â† Formatado                  â”‚
â”‚   "HMPV - R": "HMPV - 2",                  â† Mapeado                    â”‚
â”‚   "HMPV - CT": "",                         â† NÃ£o tinha no original      â”‚
â”‚   "INF A - R": "INF A - 1",               â† Mapeado (normalizado)      â”‚
â”‚   "INF A - CT": "",                        â† NÃ£o tinha                   â”‚
â”‚   ... (5 alvos totais)                                                   â”‚
â”‚   "RP1 - CT": "25,500",                    â† RP formatado              â”‚
â”‚ }                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8ï¸âƒ£ ESCRITA NO CSV (APPEND)                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Arquivo: logs/historico_analises.csv                                    â”‚
â”‚                                                                          â”‚
â”‚ Modo: APPEND (a)                                                         â”‚
â”‚ â”œâ”€ NÃ£o sobrescreve arquivo existente                                    â”‚
â”‚ â”œâ”€ Adiciona novas linhas ao final                                       â”‚
â”‚ â””â”€ Header escrito apenas se arquivo nÃ£o existe                          â”‚
â”‚                                                                          â”‚
â”‚ CSV separado por: ";" (ponto-vÃ­rgula, padrÃ£o portuguÃªs)               â”‚
â”‚ Encoding: UTF-8 sem BOM                                                 â”‚
â”‚                                                                          â”‚
â”‚ Resultado:                                                               â”‚
â”‚ data_hora_analise;usuario_analise;exame;lote;arquivo_corrida;poco;...   â”‚
â”‚ 2025-12-05 19:54:54;mÃ¡rcio;vr1e2_biomanguinhos_7500;;... 422386;...    â”‚
â”‚ [nova linha adicionada ao final do arquivo]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9ï¸âƒ£ SINCRONIZAÃ‡ÃƒO COM POSTGRESQL (Paralelo)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ FunÃ§Ã£o: salvar_historico_processamento()                                â”‚
â”‚                                                                          â”‚
â”‚ ConexÃ£o:                                                                 â”‚
â”‚ â”œâ”€ get_postgres_connection() â†’ dbname, user, password, host             â”‚
â”‚ â””â”€ Se falhar ou desabilitado â†’ Retorna None (fallback)                  â”‚
â”‚                                                                          â”‚
â”‚ Se conectado:                                                            â”‚
â”‚ â”œâ”€ Executa:                                                              â”‚
â”‚ â”‚  INSERT INTO historico_processos                                      â”‚
â”‚ â”‚  (analista, exame, status, detalhes, data_hora)                       â”‚
â”‚ â”‚  VALUES                                                                â”‚
â”‚ â”‚  ('mÃ¡rcio', 'AnÃ¡lise Manual', 'ConcluÃ­do',                            â”‚
â”‚ â”‚   'Placa: 20251205-001; 32 amostras salvas.', NOW())                  â”‚
â”‚ â”‚                                                                        â”‚
â”‚ â”œâ”€ Commit: Confirma transaÃ§Ã£o                                           â”‚
â”‚ â””â”€ Close: Fecha conexÃ£o                                                 â”‚
â”‚                                                                          â”‚
â”‚ Se nÃ£o conectado:                                                        â”‚
â”‚ â””â”€ Log: "Salvamento ignorado (conexÃ£o indisponÃ­vel.)"                   â”‚
â”‚    (Sistema continua funcionando com CSV apenas)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”Ÿ FEEDBACK AO UTILIZADOR                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Messagebox (Sucesso):                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚ â”‚ Sucesso                               â”‚                               â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                               â”‚
â”‚ â”‚ 32 amostras selecionadas foram salvas â”‚                               â”‚
â”‚ â”‚ no histÃ³rico.                         â”‚                               â”‚
â”‚ â”‚                                       â”‚                               â”‚
â”‚ â”‚           [OK]                        â”‚                               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                          â”‚
â”‚ Log (INFO):                                                              â”‚
â”‚ â”œâ”€ "Salvar HistÃ³rico"                                                   â”‚
â”‚ â””â”€ "32 amostras salvas pelo utilizador mÃ¡rcio."                        â”‚
â”‚                                                                          â”‚
â”‚ Nota: CN/CP foram removidas silenciosamente na validaÃ§Ã£o                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ TransformaÃ§Ã£o de Dados (Exemplo Real)

### ANTES (df_final original):

```
Codigo     Amostra Poco   Status_Corrida  Resultado_SC2   SC2-CT   Resultado_HMPV  HMPV-CT  RP1
422386149  422386  A1+A2  VÃ¡lida          Detectado       38.456   NÃ£o Detectado          25.5
422386266  422387  B1+B2  VÃ¡lida          NÃ£o Detectado            Detectado       35.200  28.3
CN         CN      G11+G12 VÃ¡lida         Detectado       36.200   NÃ£o Detectado          24.0
```

### DEPOIS (linha do histÃ³rico):

```
Para 422386149:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ data_hora_analise: 2025-12-05 19:54:54 â”‚
â”‚ usuario_analise: mÃ¡rcio                â”‚
â”‚ exame: vr1e2_biomanguinhos_7500        â”‚
â”‚ poco: A1+A2                             â”‚
â”‚ codigo: 422386149                       â”‚
â”‚ status_gal: analizado e nao enviado    â”‚
â”‚ SC2 - R: SC2 - 1          â† "Detectado" â†’ "1"
â”‚ SC2 - CT: 38,456          â† "38.456" â†’ "38,456"
â”‚ HMPV - R: HMPV - 2        â† "NÃ£o Detectado" â†’ "2"
â”‚ HMPV - CT: (vazio)        â† NÃ£o tinha â†’ vazio
â”‚ RP1 - CT: 25,500          â† "25.5" â†’ "25,500"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Para CN (desmarcada automaticamente):
â””â”€ NÃƒO ADICIONADO AO HISTÃ“RICO
```

---

## âš™ï¸ SequÃªncia de OperaÃ§Ãµes

```
SEQUÃŠNCIA TEMPORAL
â”‚
â”œâ”€ T0ms: Utilizador seleciona amostras na UI
â”œâ”€ T1ms: Clica botÃ£o "Salvar Selecionados"
â”‚
â”œâ”€ T2ms: _salvar_selecionados() START
â”‚  â”œâ”€ Valida: _norm_res_label()
â”‚  â”œâ”€ Remove: invalid_mask.apply()
â”‚  â””â”€ Filtra: df_selecionados = df[df["Selecionado"]]
â”‚
â”œâ”€ T50ms: gerar_historico_csv() START
â”‚  â”œâ”€ get_exam_cfg(): Carrega config do registry
â”‚  â”œâ”€ _find_ct_col(): Descobre colunas CT
â”‚  â”œâ”€ Loop por cada amostra:
â”‚  â”‚  â”œâ”€ _map_result(): Mapeia qualitativo
â”‚  â”‚  â””â”€ _fmt_ct(): Formata quantitativo
â”‚  â””â”€ pd.DataFrame(): Cria df de histÃ³rico
â”‚
â”œâ”€ T70ms: CSV Write START
â”‚  â””â”€ df_hist.to_csv(mode='a'): APPEND
â”‚
â”œâ”€ T90ms: CSV Write END
â”‚
â”œâ”€ T100ms: salvar_historico_processamento() START
â”‚  â”œâ”€ get_postgres_connection(): Conecta BD
â”‚  â”œâ”€ cursor.execute(): INSERT INTO historico_processos
â”‚  â””â”€ conn.commit(): Confirma
â”‚
â”œâ”€ T170ms: PostgreSQL END (ou timeout/fail â†’ fallback)
â”‚
â”œâ”€ T180ms: Messagebox exibido ao utilizador
â”œâ”€ T185ms: registrar_log() INFO
â””â”€ T190ms: Fim total

TOTAL: ~190ms para processar 32 amostras
```

---

## ğŸ¯ Matrix de Estados

### Estados PossÃ­veis de Uma Amostra

| CÃ³digo | Selecionado | Resultado | Status Final | AÃ§Ã£o |
|--------|-------------|-----------|--------------|------|
| NumÃ©rico | âœ… | VÃ¡lido | âœ… SALVO | Adicionado ao histÃ³rico |
| NumÃ©rico | âœ… | InvÃ¡lido | âŒ DESCARTADO | Desmarcado automaticamente |
| NumÃ©rico | âŒ | VÃ¡lido | â­ï¸ IGNORADO | NÃ£o processa |
| CN/CP | âœ… | Qualquer | âŒ DESCARTADO | Desmarcado antes de processar |
| CN/CP | âŒ | Qualquer | â­ï¸ IGNORADO | NÃ£o processa |

---

## ğŸ”’ Garantias do Sistema

```
âœ… GARANTIA 1: Controles Nunca Exportados
   â””â”€ CN/CP sÃ£o detectados antes de processar
   â””â”€ status_gal = "tipo nao enviavel"

âœ… GARANTIA 2: InvÃ¡lidos Nunca Exportados
   â””â”€ Amostras com Resultado="InvÃ¡lido" sÃ£o desmarcadas
   â””â”€ Mesmo se utilizador tentar marcar

âœ… GARANTIA 3: Nomes Normalizados
   â””â”€ Todos alvos usam cfg.normalize_target()
   â””â”€ ConsistÃªncia entre mÃ³dulos

âœ… GARANTIA 4: CT Formatado Corretamente
   â””â”€ Sempre 3 casas decimais
   â””â”€ Sempre vÃ­rgula (padrÃ£o portuguÃªs)

âœ… GARANTIA 5: PersistÃªncia Dual
   â””â”€ CSV local: nunca falha (append-only)
   â””â”€ PostgreSQL: optional (fallback funciona)

âœ… GARANTIA 6: Rastreabilidade Completa
   â””â”€ data_hora_analise: quando foi
   â””â”€ usuario_analise: quem fez
   â””â”€ exame: qual exame
   â””â”€ Tudo gravado em CSV e BD
```
